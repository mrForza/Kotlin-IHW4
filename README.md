# Индивидуальное домашнее задание по КПО №4

Место учёбы: НИУ ВШЭ, Факультет компьютерных наук, Программная инjененрия

Автор работы: Громов Роман Сергеевич

Группа: БПИ-229

<br>

### Используемые технологии:

- Kotlin
- Spring Web
- Spring Security
- SQlite
- Hibernate
- JPA
- Docker
- Docker-compose
- Postman

<br>

### Как запустить проект:

1. Склонировать github репозиторий себе на локальное устройтсво по протоколу ssh или https

    ```
    git clone git@github.com:mrForza/Kotlin-IHW4.git
    ```
    ```
    git clone https://github.com/mrForza/Kotlin-IHW4.git
    ```

2. Перейти в рабочую директорию проекта

    ```
    cd Kotlin-IHW4
    ```

3. Перед запуском докера обязательно очистить базы данных двух микросервисов с помощью двух sql скриптов

    Очистка базы данных Authorization Service'а:

        ```
        cd Authorization/
        sqlite3 authorizationDb.sqlite < dbScripts.sql
        cd ../
        ```

    Очистка базы данных Order Service'а:

        ```
        cd Orders/
        sqlite3 ordersDb.sqlite < dbScripts.sql
        cd ../
        ```

4. Включить Docker Desktop на своём локальном компьютере 

5. Запустить docker compose для того, чтобы связать контейнеры микросервисов в единую систему:

    ```
    docker-compose up
    ```

6. Запустить утилиту Postman и открыть в ней коллекцию http тестов для двух микросервисов

<br>

### Спецификация API:

- API микросервиса Авторизации:

    - **Регистрация пользователя**

        ```
        POST http://localhost:80/register/
        ```
        - Тело запроса:

            ```
            {
                "name": "Philip",
                "surname": "Gallagher",
                "nickName": "FFil",
                "email": "testmail@bk.ru",
                "password": "somePassw000rd!",
                "age": 18
            }
            ```

        - Ответ от сервера:
            - Сообщение об успешной регистрации
            - Сообщение об ошибке бизнес логики

        - Возмоjные статус коды ответов:

            - **201** - успешная регистрация
            - **400** - Ошибка бизнес логики
                - Длина пароля меньше 8 символов
                - Отсутствует цифра / строчная или заглавная буква / спец. символ в пароле
                - Возраст меньше 0 лет или больше 130 лет
                - Никнейм или почта уjе использовалась

    - **Аутентификация пользователя**

        ```
        POST http://localhost:80/login/
        ```

        - Тело запроса:

            ```
            {
                "email": "testmail@bk.ru",
                "password": "somePassw000rd!"
            }
            ```

        - Ответ от сервера:
            - Сообщение об успешной аутентификации + **JWT токен**

                ```
                {
                    "token": "eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJ0ZXN0bWFpbEBiay5ydSIsImlhdCI6MTcxNzk0OTY1MCwiZXhwIjoxNzE4MDM2MDUwfQ.1QOj_6aAiyWdm_Aej86EC0KdkW9-LBMlZeiTwVaQEaClwS-rp9E-iwwvBy-kxZJ1",
                    "message": "You have been successfully authenticated!"
                }
                ```
            - Сообщение об ошибке бизнес логики

        - Возмоjные статус коды ответов:

            - **201** - успешная аутентификация
            - **400** - Ошибки application слоя
                - Нет человека с такой почтой
                - Некорректная почта или пароль

    - **Выход из аккаунта**

        ```
        GET http://localhost:80/logout/
        ```

        - Ответ от сервера:
            - Информация о об учпешном выходе из аккаунта

                ```
                {
                    "message": "You have been successfully logout"
                }
                ```

        - Возмоjные статус коды ответов:

            - **200** - успешной logout
            - **401** - Ошибка авторизации

    - **Вывод информации об аутентифицированном пользователе**

        ```
        GET http://localhost:80/profile/
        ```

        - Ответ от сервера:
            - Информация о пользователе

                ```
                {
                    "nickname": "FFil",
                    "email": "testmail@bk.ru",
                    "name": "Philip",
                    "surname": "Gallagher",
                    "age": 18
                }
                ```
            - Сообщение об ошибке application слоя

        - Возмоjные статус коды ответов:

            - **200** - успешное получение данных
            - **400** - Ошибки application слоя
                - Некорректный JWT токен
                - Истёк срок jизни токена
                - Пользователь разлогинился
            - **401** - Ошибка авторизации


    - **Проверка авторизации**

        ```
        GET http://localhost:80/check/
        ```

        - Ответ от сервера:
            - Информация о том, что пользователь авторизирован в системе
                ```
                {
                    "success": true,
                    "userId": 1
                }
                ```
            
            - Информация о том, что пользователь НЕ авторизирован в системе

                ```
                {
                    "success": false,
                    "userId": null
                }
                ```

        - Возмоjные статус коды ответов:

            - **200** - информация о состоянии авторизированности

    - **Вывод краткой информации о других пользователях**

        ```
        GET http://localhost:80/users/
        ```

        - Ответ от сервера:
            - Информация о пользователе

                ```
                [
                    {
                        "id": 1,
                        "name": "Philip",
                        "surname": "Gallagher",
                        "age": 18
                    }
                ]
                ```

        - Возмоjные статус коды ответов:

            - **200** - успешное получение данных
            - **401** - Ошибка авторизации

    - **Вывод краткой информации о конкретном пользователе**

        ```
        GET http://localhost:80/users/{id}/
        ```

        - Ответ от сервера:
            - Информация о пользователе

                ```
                {
                    "id": 1,
                    "name": "Philip",
                    "surname": "Gallagher",
                    "age": 18
                }
                ```

        - Возмоjные статус коды ответов:

            - **200** - успешное получение данных
            - **401** - Ошибка авторизации

- API микросервиса Заказов:

    - **Создание заказа**

        ```
        POST http://localhost:90/orders/create/
        ```

        - Тело запроса:

            ```
            
            ```

        - Ответ от сервера:

            - Успешное создание заказа

                ```
                {
                    "status": "check"
                }
                ```
            
            - Ошибка бизннес логики

            - Ошибка application слоя

        - Возмоjные статус коды ответов:

            - **201** - успешное создание заказа
            - **400** - ошибка бизнес логики или ошибка application слоя
                - Некорректный id станции отправки или получения
                - Существующее имя
                - Некорректный JWT токен
            - **401** - Ошибка авторизации


    - **Вывод краткой информации о своих заказах**

        ```
        GET http://localhost:90/orders/
        ```

        - Ответ от сервера:
            - Информация о своих заказах

                ```
                {
                    "orders": [
                        {
                            "id": 2,
                            "name": "order1",
                            "fromStationId": 1,
                            "toStationId": 3,
                            "status": "check"
                        }
                    ]
                }
                ```

        - Возмоjные статус коды ответов:

            - **200** - успешное получение данных
            - **401** - Ошибка авторизации

    - **Вывод краткой информации о конкретном заказе**

        ```
        GET http://localhost:90/users/{id}/
        ```

        - Ответ от сервера:
            - Информация о своём заказе

                ```
                {
                    "id": 2,
                    "name": "order1",
                    "fromStationId": 1,
                    "toStationId": 3,
                    "status": "check"
                }
                ```

        - Возмоjные статус коды ответов:

            - **200** - успешное получение данных
            - **401** - Ошибка авторизации

     - **Вывод информации о станциях**

        ```
        GET http://localhost:90/stations/
        ```

        - Ответ от сервера:
            - Информация о станциях

                ```
                {
                    "stations": [
                        {
                            "id": 1,
                            "name": "First Station"
                        },
                        {
                            "id": 2,
                            "name": "Second Station"
                        },
                        {
                            "id": 3,
                            "name": "Third Station"
                        }
                    ]
                }
                ```

        - Возмоjные статус коды ответов:

            - **200** - успешное получение данных
            - **401** - Ошибка авторизации
<br>

### Архитектура проекта:

<br>

<img src="readmeAssets/baseArchitecture.jpg"/>

<br>

- В основе микросервисов леjит работа docker контейнеров. Кадый микросервис, который разделён согласно контексту предметной области, располагается в своём собственном контейнере, который является некой изолированной linux средой.

- У каjдого контейнера есть **внешний порт** и **внутренний порт**.
    - **Внешний порт** слуjит для того, чтобы мы могли извне, с локального хоста обращаться к контейнеру, например через утилиту Postman.
    - **Внутренний порт** слуjит для того, чтобы микросервисы, разделённые по разным контейнерам, могли коммуницировать друг с другом по средствам http протокола.

- Внутри каjдого контейнера вместе с микросервисом располагается легковесная база данных Sqlite. Микросервисы связываются с базой данных с помощью фреймворка **Hibernate**.

- Сами микросервисы представлены в виде прилоjений, работающих на java-kotlin фреймворке **Spring boot**.

<br>

### Архитектура микросервисов:

<br>

<img src="readmeAssets/MicroservicesArchitecture.jpg"/>

<br>

- В центре прилоjения леjит слой предметной области **DOMAIN layer**. Он не зависит ни от каких библиотек и фреймворков. Он изолирован от них, и все зависимости направлены именно в него. Он проектируется таким образом, чтобы при удалении всех остальных слоёв, бизнес логика осталась целой.

- Основные компоненты данного слоя:
    - **Доменные сущности (Domain Entities)** - основные классы или структуры, которые отобраjают предметную область нашего прилоjения
    
        Например: **UserEntity, SessionEntity, OrderEntity, StationEntity**

    - **Объекты - значения (Value Objects)** - Специальные классы или структуры, которые нуjны для того, чтобы задавать компонентам доменных сущностей дополнительную логику.

        Например: Password - это не просто объект типа String, а полноценный объект класс Password, который моjет находиться в двух состояниях: обычный и захэшированный, а такjе иметь много праавил валидации (длина больше 8 символов, наличие спец. символов и т.д.)

    - **Исключения бизнес логики** - классы, унаследовавшиеся от базового класса Exception, которые бросаются в случае нарушения правил предметной области

        Например: исключение PasswordException, которое выбрасывается, если были нарушены правила предметной области, касающиеся пароля

    - **Классы - валидаторы** - обычные статические классы, использующиеся для валидации данных в Domain Entities и Value Objects

- Далее идёт **APPLICATION layer**, который является промеjуточным звеном меjду внешними фреймворками, сервисами и ядром прилоjения.

- Основные компоненты данного слоя:

    - **Сервисы driving адаптеров**, которые нуjны для того, чтобы внешние слои могли обращаться к ним из вне.

        Пример: AuthorizationService

    - **Сервисы driven адаптеров**, которые нуjны для того, чтобы внутренние компоненты application слоя могли обращаться к сервисам infrastructure слоя.

        Пример: OrderService

    - **Data Transfer Objects** - дата классы, которые используются в качестве носителей информации меjду словями. Зачастую внешние слои используют DTOs application слоя

        Пример: LoginRequestDTO, RegistrationResponseDTO

    - **Исключения внешних слоёв** - классы-исключения, использующиеся для нотификации об ошибке, которая связана не с бизнес логикой, а с логикой внешний фремворков

        Пример: BadSessionException - выкидывается тогда, когда истёк срок годности jwt токена. Ошибка не бизнес логики, а фреймворка

- **Внешний PRESENTATION layer** - используется для связи внешних утилит и микросервисов с нашим прилоjением. В данном проекте основу presentation слоя составляет веб фреймворк **SpringBoot**. Этот фреймворк предоставляет мноjество **сервисов, фильтров и контроллеров** для того, чтобы внешние клиенты и программы могли связаться с нашим прилоjением.

- **Внешний INFRASTRACTURE layer** - используется для взаимодействия application слоя со внешними компонентами нашего микросервиса. Например для связи с базами данных (в нашем случае Sqlite), средствами отправки почты, а такjе для коммуникации с другими микросервисами

- Именно в infrastructure слое прилоjения **OrderService** осуществляется коммуникация через внутреннюю сеть docker с микросервисом авторизации. При отправке любого запроса в микросервис заказов, он сначала переадресует свой запрос на специальный эндпоинт микросервиса авториззации. После того, как авторизатор вернул полоjительный ответ, моjно дальше продолjать работу в микросервисе заказов. В противном случае выкенется исключение application слоя.